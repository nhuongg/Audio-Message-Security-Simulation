<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√¥ ph·ªèng B·∫£o m·∫≠t Tin nh·∫Øn √Çm thanh</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; line-height: 1.6; padding: 20px; background-color: #f4f7f9; color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2 { color: #0056b3; border-bottom: 2px solid #eef; padding-bottom: 10px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .box { padding: 20px; border: 1px solid #ddd; border-radius: 5px; background-color: #fafafa; }
        textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; font-size: 13px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin-top: 10px; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #stop-recording-btn { background-color: #dc3545; }
        #stop-recording-btn:hover { background-color: #c82333; }
        pre { background-color: #eef; padding: 15px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-size: 13px; max-height: 300px; overflow-y: auto; }
        label { font-weight: bold; margin-bottom: 5px; display: block; }
        .full-width { grid-column: 1 / -1; }
        #recording-status { margin-top: 15px; font-weight: bold; color: #17a2b8; }
        #audio-playback-container { margin-top: 20px; display: none; }
        audio { width: 100%; }
    </style>
</head>
<body>
    <div class="container">
        <h1>M√¥ ph·ªèng Truy·ªÅn tin √Çm thanh An to√†n (AES-256 & RSA-2048)</h1>
        <div class="box full-width">
            <h2>B∆∞·ªõc 1: T·∫°o kh√≥a</h2>
            <p>Nh·∫•n n√∫t ƒë·ªÉ t·∫°o c√°c c·∫∑p kh√≥a RSA cho Alice (Ng∆∞·ªùi g·ª≠i) v√† Bob (Ng∆∞·ªùi nh·∫≠n).</p>
            <button id="generate-keys-btn">T·∫°o Kh√≥a cho c·∫£ Alice v√† Bob</button>
        </div>
        <div class="grid">
            <div class="box">
                <h2>Ph√≠a Ng∆∞·ªùi g·ª≠i (Alice)</h2>
                <label for="alice-public-key">Kh√≥a c√¥ng khai c·ªßa Alice:</label>
                <textarea id="alice-public-key" readonly></textarea>
                <label for="alice-private-key">Kh√≥a ri√™ng c·ªßa Alice:</label>
                <textarea id="alice-private-key" readonly></textarea>
                <hr>
                <label for="bob-public-key-input">Kh√≥a c√¥ng khai c·ªßa Bob (ƒë√£ t·ª± ƒëi·ªÅn):</label>
                <textarea id="bob-public-key-input"></textarea>
                <hr>
                <label>Ghi √¢m Tin nh·∫Øn tho·∫°i:</label>
                <div>
                    <button id="start-recording-btn" disabled>B·∫Øt ƒë·∫ßu Ghi √¢m</button>
                    <button id="stop-recording-btn" disabled>D·ª´ng Ghi √¢m</button>
                </div>
                <div id="recording-status">Tr·∫°ng th√°i: S·∫µn s√†ng. (Vui l√≤ng t·∫°o kh√≥a tr∆∞·ªõc)</div>
                <div id="audio-playback-container">
                    <label>Nghe l·∫°i b·∫£n ghi √¢m ƒë√£ g·ª≠i:</label>
                    <audio id="audio-playback" controls></audio>
                </div>
            </div>
            <div class="box">
                <h2>Ph√≠a Ng∆∞·ªùi nh·∫≠n (Bob)</h2>
                <label for="bob-public-key">Kh√≥a c√¥ng khai c·ªßa Bob:</label>
                <textarea id="bob-public-key" readonly></textarea>
                <label for="bob-private-key">Kh√≥a ri√™ng c·ªßa Bob:</label>
                <textarea id="bob-private-key" readonly></textarea>
            </div>
        </div>
        <div class="box full-width">
            <h2>K·∫øt qu·∫£ X·ª≠ l√Ω</h2>
            <h3>G√≥i tin ƒë∆∞·ª£c g·ª≠i ƒëi (JSON):</h3>
            <pre id="packet-output">G√≥i tin s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y...</pre>
            <h3>Nh·∫≠t k√Ω x·ª≠ l√Ω (Log):</h3>
            <pre id="log-output">Nh·∫≠t k√Ω c√°c b∆∞·ªõc s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y...</pre>
        </div>
    </div>

    <script>
        // --- L·∫•y tham chi·∫øu ƒë·∫øn c√°c ph·∫ßn t·ª≠ HTML ƒë·ªÉ ƒëi·ªÅu khi·ªÉn ch√∫ng ---
        const generateBtn = document.getElementById('generate-keys-btn');
        const startRecordingBtn = document.getElementById('start-recording-btn');
        const stopRecordingBtn = document.getElementById('stop-recording-btn');
        const statusDiv = document.getElementById('recording-status');
        const audioPlayback = document.getElementById('audio-playback');
        const audioPlaybackContainer = document.getElementById('audio-playback-container');
        const logOutput = document.getElementById('log-output');

        // --- Bi·∫øn cho vi·ªác ghi √¢m ---
        let mediaRecorder;
        let audioChunks = [];

        // --- X·ª≠ l√Ω s·ª± ki·ªán khi ng∆∞·ªùi d√πng nh·∫•n n√∫t "T·∫°o Kh√≥a" ---
        generateBtn.addEventListener('click', async () => {
            logOutput.textContent = 'ƒêang t·∫°o kh√≥a...';
            try {
                const response = await fetch('/generate-all-keys', { method: 'POST' });
                const data = await response.json();

                document.getElementById('alice-public-key').value = data.alice_public_key;
                document.getElementById('alice-private-key').value = data.alice_private_key;
                document.getElementById('bob-public-key').value = data.bob_public_key;
                document.getElementById('bob-private-key').value = data.bob_private_key;
                document.getElementById('bob-public-key-input').value = data.bob_public_key;

                logOutput.textContent = 'ƒê√£ t·∫°o kh√≥a th√†nh c√¥ng! S·∫µn s√†ng ƒë·ªÉ ghi √¢m.';
                startRecordingBtn.disabled = false;
            } catch (error) {
                logOutput.textContent = `L·ªói khi t·∫°o kh√≥a: ${error.message}.`;
            }
        });

        // --- X·ª≠ l√Ω s·ª± ki·ªán khi nh·∫•n n√∫t "B·∫Øt ƒë·∫ßu Ghi √¢m" ---
        startRecordingBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                audioPlaybackContainer.style.display = 'none';

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayback.src = audioUrl;
                    audioPlaybackContainer.style.display = 'block';

                    const formData = new FormData();
                    formData.append('audio_data', audioBlob, 'recording.webm');
                    formData.append('alice_private_key', document.getElementById('alice-private-key').value);
                    formData.append('alice_public_key', document.getElementById('alice-public-key').value);
                    formData.append('bob_public_key', document.getElementById('bob-public-key-input').value);
                    formData.append('bob_private_key', document.getElementById('bob-private-key').value);

                    logOutput.textContent = 'ƒê√£ d·ª´ng ghi √¢m. ƒêang g·ª≠i d·ªØ li·ªáu ƒë·ªÉ m√£ h√≥a v√† x·ª≠ l√Ω...';

                    const response = await fetch('/process-message', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();

                    if (result.success) {
                        document.getElementById('packet-output').textContent = JSON.stringify(result.packet, null, 2);
                    } else {
                        document.getElementById('packet-output').textContent = 'C√≥ l·ªói x·∫£y ra.';
                    }
                    logOutput.textContent = result.log;
                };

                mediaRecorder.start();
                statusDiv.textContent = "üî¥ ƒêang ghi √¢m...";
                startRecordingBtn.disabled = true;
                stopRecordingBtn.disabled = false;

            } catch (err) {
                statusDiv.textContent = `L·ªói: ${err.message}. B·∫°n ƒë√£ cho ph√©p truy c·∫≠p micro ch∆∞a?`;
            }
        });

        // --- X·ª≠ l√Ω s·ª± ki·ªán khi nh·∫•n n√∫t "D·ª´ng Ghi √¢m" ---
        stopRecordingBtn.addEventListener('click', () => {
            mediaRecorder.stop();
            statusDiv.textContent = "Tr·∫°ng th√°i: S·∫µn s√†ng ghi √¢m.";
            startRecordingBtn.disabled = false;
            stopRecordingBtn.disabled = true;
        });
    </script>
</body>
</html>